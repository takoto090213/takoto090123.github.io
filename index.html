<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>脱毛料金シミュレーター（フル版）</title>
  <style>
    :root{--brand:#0077c8;--brand2:#00b3a4;--ink:#333;--box:#e6eef7;--accent:#f2f9ff;--border:#d8e2ee}
    *{box-sizing:border-box}
    html,body{height:100%}
    html{background:#f7f9fc}
    body{margin:0;background:#f7f9fc;color:var(--ink);font-family:'Hiragino Sans',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;min-height:100vh}
    header{background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;padding:22px 16px;display:grid;grid-template-columns:1fr auto 1fr;align-items:center}
    header h1{margin:0;font-size:22px;grid-column:2;justify-self:center}
    header .copyright{font-size:12px;opacity:.9;grid-column:3;justify-self:end}
    .wrap{max-width:1200px;margin:0 auto;padding:16px;overflow:visible}

    h2{border-left:6px solid var(--brand2);padding-left:10px;color:var(--brand);margin:2px 0 12px}
    label{display:block;margin-top:10px;font-weight:700}
    input,select,button{font-size:14px}
    input,select{width:100%;padding:9px;border:1px solid #cfd9e6;border-radius:8px;margin-top:6px;background:#fff;position:relative;z-index:5;background-clip:padding-box}
    input.need-attn,select.need-attn{border-color:#b00020;color:#b00020}
    select{appearance:auto}
    select:focus,input:focus{outline:none;box-shadow:0 0 0 2px rgba(0,119,200,.15)}
    .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px;margin-bottom:8px;overflow:visible}

    .cards{display:grid;gap:12px}
    .cards.two-col{grid-template-columns:1fr 1fr}
    @media(max-width:640px){.cards.two-col{grid-template-columns:1fr}}
    .card{background:var(--accent);border:1px solid var(--border);border-radius:12px;padding:12px}
    .card h3{margin:0 0 6px;font-size:12px;color:#2b4058;font-weight:800;letter-spacing:.2px}
    .card p{margin:0;font-size:18px;font-weight:700;color:#0e3352;white-space:pre-line}
    .card.highlight{background:#fff;border:2px solid var(--brand);box-shadow:0 0 0 3px rgba(0,119,200,.06)}
    .card.highlight p{font-size:22px}

    table{width:100%;border-collapse:separate;border-spacing:0 6px}
    th,td{background:#fff;border:1px solid #dfe8f3;padding:8px}
    .error{color:#b00020;font-size:13px;white-space:pre-line}

    .pillset{display:flex;gap:8px;flex-wrap:wrap}
    .pill{border:1px solid #cfd9e6;padding:8px 12px;border-radius:999px;background:#fff;cursor:pointer;user-select:none}
    .pill.active{border-color:var(--brand);box-shadow:0 0 0 3px rgba(0,119,200,.08)}

    .tiers{display:grid;gap:12px;margin-top:6px}
    /* swipe 入れ替えを確実に動作させるため、カード上ではブラウザのデフォルトスクロールを抑制 */
    .plan-card{border:1px solid #dfe8f3;border-radius:12px;padding:12px;background:#fff;min-height:172px;user-select:none;touch-action:none}
    .plan-card.active{border-color:var(--brand);box-shadow:0 0 0 3px rgba(0,119,200,.06)}
    .plan-card .title{font-weight:900;color:#143a55;margin-bottom:8px}
    .plan-card .price{font-size:18px;font-weight:900;color:#0b62a4;background:#e7f2ff;border:1px solid #cfe6ff;border-radius:8px;padding:6px 8px;display:inline-block}
    .plan-card .planlist{font-size:18px;line-height:1.6;font-weight:800;color:#0b2f4a;margin-top:8px;letter-spacing:.2px}
    .plan-card .planline{display:block;margin:.12rem 0}
    .plan-card .monthly{margin-top:6px;font-size:16px;font-weight:900;color:#0a6b58;background:#e9f8f5;border:1px solid #c9eee7;border-radius:8px;padding:4px 8px;display:inline-block}
    .plan-card .badge{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;border:1px solid #86e1d3;background:#f0fffb;color:#0a6b58;font-size:12px;font-weight:800}
    .plan-card[data-tier="matsu"]{background:linear-gradient(180deg,#fff,#f2f8ff)}
    .plan-card[data-tier="take"]{background:linear-gradient(180deg,#fff,#f7fbff)}
    .plan-card[data-tier="ume"]{background:linear-gradient(180deg,#fff,#fbfdff)}

    .swipe-shadow{transition:box-shadow .12s ease}
    .swipe-shadow.swiping{box-shadow:0 6px 14px rgba(0,0,0,.15)}

    .btn-wrap{display:flex;align-items:end}
    .ann{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;border:1px solid #ffb3b3;background:#fff5f5;color:#b00020;font-size:12px;font-weight:800}
    .result .cards + .cards{margin-top:18px}
    .cards.two-col{margin-bottom:12px}
    [hidden]{display:none!important}

    .ops{display:flex; gap:10px; align-items:center; flex-wrap:wrap}

    .tabs{display:flex;gap:8px;justify-content:center;margin:10px 0}
    .tab{padding:8px 14px;border:1px solid #dde6f1;border-bottom:none;background:#e0e7ef;color:#123;font-weight:700;border-radius:10px 10px 0 0;cursor:pointer}
    .tab.active{background:#fff;color:var(--brand);box-shadow:inset 0 -4px 0 var(--brand2)}
    .tab-content{display:none;background:#fff;padding:18px;border-radius:0 0 12px 12px;box-shadow:0 2px 10px rgba(0,0,0,.08);max-width:1200px;margin:0 auto 20px;border:1px solid #eef3f9}
    .tab-content.active{display:block}
    .swipe-hint{margin-top:10px;font-size:12px;color:#5a6a7c}
  
    /* POP UI (inline) */
    .pop-section{margin:14px 0 18px}
    .pop-section .pop-sub{font-size:12px;color:#5a6a7c;margin:6px 0 10px}
    .pop-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    .pop-card{background:#fff;border:1px solid #e5eef8;border-radius:14px;box-shadow:0 1px 10px rgba(0,0,0,.05);overflow:hidden}
    .pop-card .banner{padding:14px 14px 12px;background:linear-gradient(90deg,#e7f2ff,#e9f8f5)}
    .pop-card .tag{display:inline-block;font-size:12px;font-weight:900;padding:4px 10px;border-radius:999px;background:#fff;border:1px solid #dbe8f6;color:#143a55}
    .pop-card .title{margin-top:8px;font-size:16px;font-weight:1000;color:#0e3352;letter-spacing:.2px}
    .pop-card .hint{margin-top:4px;font-size:12px;color:#496073}
    .pop-card .body{padding:12px 14px 14px}
    .pop-list{display:flex;flex-direction:column;gap:8px}
    .pop-row{display:flex;align-items:center;justify-content:space-between;gap:10px;border:1px solid #eef3f9;border-radius:12px;padding:10px 10px;background:#fbfdff}
    .pop-row .left{display:flex;flex-direction:column;gap:2px}
    .pop-row .course{font-size:14px;font-weight:900;color:#123}
    .pop-row .total{font-size:13px;font-weight:800;color:#0b62a4}
    .pop-row button{border:1px solid #cfd9e6;background:#fff;border-radius:10px;padding:8px 10px;font-weight:900;cursor:pointer}
    .pop-row button:hover{box-shadow:0 0 0 3px rgba(0,119,200,.08)}
    

    /* 料金表タブ：ミニプランカード */
    .mini-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin:10px 0 14px}
    .mini-card{border:1px solid #dfe8f3;border-radius:12px;padding:10px;background:#fff;cursor:pointer}
    .mini-card.active{box-shadow:0 0 0 3px rgba(0,123,255,.10)}
    .mini-top{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .mini-title{font-weight:1000}
    .mini-badges{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
    .mini-badge{font-size:11px;font-weight:900;padding:3px 8px;border-radius:999px;border:1px solid #dbe8f6;background:#f5fbff;color:#0b62a4}
    .mini-badge-custom{background:#fff6e7;border-color:#ffe0ad;color:#925a00}
    .mini-price{font-size:18px;font-weight:1100;margin-top:6px}
    .mini-monthly{font-size:12px;color:#496073;margin-top:2px}
    .mini-planlist{margin-top:6px;display:flex;flex-direction:column;gap:4px;max-height:72px;overflow:auto;padding-right:2px}
    .mini-planlist .planline{font-size:11px;line-height:1.25;color:#234}


/* ===========================
   POP THEME: Premium Aqua
   - 清潔感(水色) + 高級感(余白/タイポ/コントラスト)
   =========================== */
:root{
  --pop-ink:#0F1F2E;
  --pop-muted:#5E7388;
  --pop-line:rgba(15,31,46,.10);
  --pop-line-soft:rgba(15,31,46,.06);
  --pop-accent:#1677C8;        /* 深めの水色 */
  --pop-accent-soft:#EAF6FF;   /* うす水色 */
  --pop-accent-glow:#F4FBFF;   /* さらに薄い */
}

.pop-section h2{
  color:var(--pop-ink);
  letter-spacing:.2px;
  font-weight:900;
}

.pop-section .pop-sub{
  color:var(--pop-muted);
  line-height:1.55;
}

/* card */
.pop-card{
  border:1px solid var(--pop-line);
  border-radius:18px;
  box-shadow:0 1px 12px rgba(15,31,46,.05); /* 影は薄く */
  background:#fff;
}

.pop-card .banner{
  padding:16px 16px 12px;
  background:
    radial-gradient(900px 220px at 12% 0%, rgba(22,119,200,.10), transparent 60%),
    linear-gradient(180deg, var(--pop-accent-glow), #fff 70%);
  border-bottom:1px solid var(--pop-line-soft);
}

.pop-card .tag{
  font-size:11px;
  font-weight:900;
  letter-spacing:.35px;
  text-transform:uppercase;
  color:var(--pop-accent);
  background:rgba(22,119,200,.06);
  border:1px solid rgba(22,119,200,.18);
  padding:4px 10px;
}

.pop-card .title{
  margin-top:10px;
  font-size:16px;
  font-weight:1000;
  color:var(--pop-ink);
  letter-spacing:.15px;
}

.pop-card .hint{
  margin-top:6px;
  font-size:12px;
  color:var(--pop-muted);
}

.pop-card .body{
  padding:14px 16px 16px;
}

/* rows */
.pop-row{
  border:1px solid var(--pop-line-soft);
  background:#fff;
  border-radius:14px;
  padding:12px 12px;
}

.pop-row:hover{
  border-color:rgba(22,119,200,.22);
  box-shadow:0 4px 18px rgba(15,31,46,.06);
}

.pop-row .course{
  font-size:14px;
  font-weight:950;
  color:var(--pop-ink);
  letter-spacing:.1px;
}

.pop-row .total{
  font-size:13px;
  font-weight:900;
  color:var(--pop-accent);
}

/* button: outline + subtle fill on hover */
.pop-row button{
  min-width:76px;
  border-radius:12px;
  border:1px solid rgba(22,119,200,.28);
  background:#fff;
  color:var(--pop-accent);
  padding:9px 12px;
  font-weight:950;
  letter-spacing:.2px;
}

.pop-row button:hover{
  background:rgba(22,119,200,.08);
  box-shadow:0 0 0 3px rgba(22,119,200,.10);
}

.pop-row button:active{
  transform:translateY(1px);
}

/* tighter, consistent grid spacing on large screens */
@media (min-width: 900px){
  .pop-grid{ gap:14px; }
}


/* Hide static helper text in 料金表POP section; hero includes guidance */
.pop-section > .pop-sub:first-child{ display:none; }


/* ===========================
   POP LIKE UI (Screenshot style)
   =========================== */
.pop-grid{
  display:flex;
  flex-direction:column;
  gap:14px;
}

/* header "hero" */
.pop-hero{
  border-radius:18px;
  padding:18px 18px 16px;
  background:
    radial-gradient(900px 260px at 18% 0%, rgba(70, 145, 210, .20), transparent 60%),
    linear-gradient(180deg, rgba(234, 246, 255, 1), rgba(255,255,255,1) 72%);
  border:1px solid rgba(17, 49, 75, .08);
  box-shadow:0 10px 26px rgba(15,31,46,.06);
}

.pop-hero-inner{max-width:100%}
.pop-hero-top{
  display:flex;
  align-items:center;
  gap:12px;
}
.pop-hero-icon{
  width:44px;
  height:44px;
  border-radius:14px;
  display:flex;
  align-items:center;
  justify-content:center;
  color:rgba(22,119,200,1);
  background:rgba(22,119,200,.10);
  border:1px solid rgba(22,119,200,.16);
  box-shadow:0 8px 18px rgba(15,31,46,.08);
}
.pop-hero-title{
  font-size:26px;
  font-weight:950;
  letter-spacing:.2px;
  color:#0F1F2E;
}
.pop-hero-sub{
  margin-top:8px;
  font-size:14px;
  color:#5E7388;
}

/* group sub heading (when multiple pops in one category) */
.pop-subhead{
  margin:10px 0 0;
  font-weight:900;
  color:#0F1F2E;
  opacity:.75;
  letter-spacing:.14px;
}

/* each row */
.pop-pill{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:14px;
  border-radius:18px;
  padding:16px 16px;
  background:#fff;
  border:1px solid rgba(17, 49, 75, .08);
  box-shadow:0 10px 24px rgba(15,31,46,.06);
}

.pop-pill-left{
  display:flex;
  flex-direction:column;
  gap:6px;
  min-width:0;
}
.pop-pill-left .k{
  font-size:16px;
  font-weight:950;
  color:#0F1F2E;
  letter-spacing:.12px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.pop-pill-left .v{
  font-size:13px;
  font-weight:900;
  color:rgba(22,119,200,1);
}

/* Add button */
.pop-add{
  border:0;
  cursor:pointer;
  padding:12px 18px;
  min-width:92px;
  border-radius:18px;
  color:#fff;
  font-weight:950;
  letter-spacing:.2px;
  background:linear-gradient(180deg, rgba(130, 175, 217, 1), rgba(64, 116, 171, 1));
  box-shadow:
    0 12px 24px rgba(15,31,46,.18),
    inset 0 1px 0 rgba(255,255,255,.35);
}
.pop-add:hover{
  filter:brightness(1.03);
  box-shadow:
    0 14px 28px rgba(15,31,46,.22),
    inset 0 1px 0 rgba(255,255,255,.38);
}
.pop-add:active{
  transform:translateY(1px);
}

/* responsive tweaks */
@media (max-width: 560px){
  .pop-hero-title{font-size:22px}
  .pop-pill{padding:14px 14px}
  .pop-add{min-width:84px;padding:11px 14px}
}


/* hide face icon in POP header */
.pop-hero-icon{display:none !important;}
.pop-hero-top{gap:0 !important;}

</style>
</head>
<body>
  <header><h1>脱毛料金シミュレーター</h1><div class="copyright" id="copyright"></div></header>

  <div class="tabs">
    <div class="tab" data-tab="price">料金表</div>
    <div class="tab active" data-tab="campaign">キャンペーン</div>
    <div class="tab" data-tab="normal">通常料金</div>
  </div>

  
  <!-- 料金表（キャンペーンPOP風UI） -->
  <section id="tab-price" class="tab-content">
    <div class="wrap">
      <div class="row">
        <label>編集ターゲット：</label>
        <div class="pillset" role="tablist">
          <div class="pill active" data-target="matsu" role="tab" aria-selected="true">プラン①</div>
          <div class="pill" data-target="take" role="tab" aria-selected="false">プラン②</div>
          <div class="pill" data-target="ume" role="tab" aria-selected="false">プラン③</div>
        </div>
      </div>

      
      <div class="mini-cards" id="mini-cards-price" aria-label="料金表タブ内のプラン①〜③ミニ表示">
        <div class="mini-card active" data-tier="matsu" role="button" tabindex="0" aria-label="プラン①に切り替え">
          <div class="mini-top">
            <div class="mini-title">プラン①</div>
            <div class="mini-badges">
              <span class="mini-badge" id="mini-badge-matsu" hidden>学割</span>
              <span class="mini-badge mini-badge-custom" id="mini-custbadge-matsu" hidden>別計算</span>
            </div>
          </div>
          <div class="mini-price" id="mini-price-matsu">¥0</div>
          <div class="mini-monthly" id="mini-monthly-tier-matsu">月々 —</div>
          <div class="mini-planlist" id="mini-planlist-matsu"><span class="planline">（プラン未選択）</span></div>
        </div>

        <div class="mini-card" data-tier="take" role="button" tabindex="0" aria-label="プラン②に切り替え">
          <div class="mini-top">
            <div class="mini-title">プラン②</div>
            <div class="mini-badges">
              <span class="mini-badge" id="mini-badge-take" hidden>学割</span>
              <span class="mini-badge mini-badge-custom" id="mini-custbadge-take" hidden>別計算</span>
            </div>
          </div>
          <div class="mini-price" id="mini-price-take">¥0</div>
          <div class="mini-monthly" id="mini-monthly-tier-take">月々 —</div>
          <div class="mini-planlist" id="mini-planlist-take"><span class="planline">（プラン未選択）</span></div>
        </div>

        <div class="mini-card" data-tier="ume" role="button" tabindex="0" aria-label="プラン③に切り替え">
          <div class="mini-top">
            <div class="mini-title">プラン③</div>
            <div class="mini-badges">
              <span class="mini-badge" id="mini-badge-ume" hidden>学割</span>
              <span class="mini-badge mini-badge-custom" id="mini-custbadge-ume" hidden>別計算</span>
            </div>
          </div>
          <div class="mini-price" id="mini-price-ume">¥0</div>
          <div class="mini-monthly" id="mini-monthly-tier-ume">月々 —</div>
          <div class="mini-planlist" id="mini-planlist-ume"><span class="planline">（プラン未選択）</span></div>
        </div>
      </div>

<div class="row">
        <label>カテゴリ<select id="pop-cat-select">

          <option value="ヒゲ">ヒゲ（眉小鼻無し）</option>
          <option value="フェイス">フェイス</option>
          <option value="どこでも脱毛">どこでも脱毛</option>
          <option value="全身">全身</option>
          <option value="全身ヒゲ">全身ヒゲ</option>
          <option value="陰部">陰部</option>
          <option value="眉小鼻">眉小鼻</option>
          <option value="大人の身だしなみケアプラン">大人の身だしなみケアプラン</option>
        
        </select></label>
      </div>

      <div class="pop-section" aria-label="料金表（POP）">
        <div class="pop-sub">選択カテゴリのPOPだけを表示します。回数ボタンを押すとキャンペーンのプラン①〜③へ追加されます。</div>
        <div id="pop-status" style="margin:8px 0 10px;font-size:12px;color:#5E7388;display:none"></div>
        <div class="pop-grid" id="pop-grid"></div>
        <div id="pop-empty" class="pop-sub" style="display:none">このカテゴリのPOPはまだありません。</div>
      </div>
    </div>
  </section>

<!-- キャンペーン -->
  <section id="tab-campaign" class="tab-content active">
    <div class="wrap">
      <div class="row">
        <label>編集ターゲット：</label>
        <div class="pillset" role="tablist">
          <div class="pill active" data-target="matsu" role="tab" aria-selected="true">プラン①</div>
          <div class="pill" data-target="take" role="tab" aria-selected="false">プラン②</div>
          <div class="pill" data-target="ume" role="tab" aria-selected="false">プラン③</div>
        </div>
      </div>

      <div class="row">
        <label>カテゴリ<select id="cat-select-c">
          <option value="ヒゲ">ヒゲ（眉小鼻無し）</option>
          <option value="フェイス">フェイス</option>
          <option value="どこでも脱毛">どこでも脱毛</option>
          <option value="全身">全身</option>
          <option value="全身ヒゲ">全身ヒゲ</option>
          <option value="陰部">陰部</option>
          <option value="眉小鼻">眉小鼻</option>
          <option value="大人の身だしなみケアプラン">大人の身だしなみケアプラン</option>
        </select></label>
        <label>プラン<select id="plan-select-c"></select></label>
      </div>
      <div class="row">
        <label>選択プラン金額（税込）<input id="selected-plan-price-c" readonly value="0"></label>
        <div class="btn-wrap"><button id="add-plan-c" type="button">＋追加</button></div>
      </div>
<div class="tiers" id="compare-cards" aria-label="プラン①〜③比較">
        <div class="plan-card swipe-shadow active" data-tier="matsu">
          <div class="title">プラン① <span class="ann" id="ann-matsu" hidden>頭金、ボーナス注意</span><span class="badge" id="badge-matsu" hidden>学割</span><span class="badge" id="custbadge-matsu" hidden>別計算</span></div>
          <div class="price" id="price-matsu">¥0</div>
          <div class="monthly" id="monthly-tier-matsu">月々 —</div>
          <div class="planlist" id="planlist-matsu"><span class="planline">（プラン未選択）</span></div>
          <div class="swipe-hint">↑↓スワイプで②/③と入替</div>
        </div>
        <div class="plan-card swipe-shadow" data-tier="take">
          <div class="title">プラン② <span class="ann" id="ann-take" hidden>頭金、ボーナス注意</span><span class="badge" id="badge-take" hidden>学割</span><span class="badge" id="custbadge-take" hidden>別計算</span></div>
          <div class="price" id="price-take">¥0</div>
          <div class="monthly" id="monthly-tier-take">月々 —</div>
          <div class="planlist" id="planlist-take"><span class="planline">（プラン未選択）</span></div>
          <div class="swipe-hint">↑↓スワイプで①/③と入替</div>
        </div>
        <div class="plan-card swipe-shadow" data-tier="ume">
          <div class="title">プラン③ <span class="ann" id="ann-ume" hidden>頭金、ボーナス注意</span><span class="badge" id="badge-ume" hidden>学割</span><span class="badge" id="custbadge-ume" hidden>別計算</span></div>
          <div class="price" id="price-ume">¥0</div>
          <div class="monthly" id="monthly-tier-ume">月々 —</div>
          <div class="planlist" id="planlist-ume"><span class="planline">（プラン未選択）</span></div>
          <div class="swipe-hint">↑↓スワイプで①/②と入替</div>
        </div>
      </div>

      <div class="row">
        <table>
          <thead><tr><th>カテゴリ</th><th>プラン（回数名）</th><th>金額</th><th>操作</th></tr></thead>
          <tbody id="combo-body-c"></tbody>
        </table>
      </div>
      <div class="row">
        <label>組み合わせ合計（税込・自動反映）<input id="combo-total-c" readonly value="0"></label>
      </div>

      <h2>分割シミュレーション（キャンペーン）</h2>
      <div class="row">
        <label>プラン総額（税込）<input type="number" id="total-campaign" value="0" readonly></label>
        <label>頭金（1000円以上・千円単位）<input type="number" id="downPayment-campaign" value="" min="1000" step="1000" class="need-attn" placeholder="例: 100000"></label>
      </div>
      <div class="row">
        <label>支払い回数（1,2,6〜50回）<select id="months-campaign" class="need-attn"></select></label>
        <label>ボーナス利用<select id="bonus-toggle-campaign"><option value="off">なし</option><option value="on">あり</option></select></label>
      </div>
      <div class="row" id="bonus-row-campaign" style="display:none">
        <label>ボーナス加算金（千円単位/月）<input type="number" id="bonus-campaign" value="" min="0" step="1000" class="need-attn" placeholder="例: 20000"></label>
        <label>ボーナス支払月（夏）<select id="bonus-summer-campaign"><option value="">選択なし</option><option value="6">6月</option><option value="7">7月</option><option value="8">8月</option></select></label>
        <label>ボーナス支払月（冬）<select id="bonus-winter-campaign"><option value="">選択なし</option><option value="12">12月</option><option value="1">1月</option></select></label>
      </div>
      <div class="result">
        <div class="cards two-col">
          <div class="card"><h3>初回のお支払い</h3><p id="first-campaign">¥0</p></div>
          <div class="card highlight"><h3>2回目以降のお支払い</h3><p id="monthly-campaign">¥0</p></div>
          <div class="card"><h3>クレジット残高</h3><p id="principal-campaign">¥0</p></div>
          <div class="card"><h3>分割手数料</h3><p id="fee-campaign">¥0</p></div>
          <div class="card"><h3>分割支払い金合計</h3><p id="sum-campaign">¥0</p></div>
          <div class="card"><h3>支払総額（頭金含む）</h3><p id="grand-campaign">¥0</p></div>
        </div>
        <div class="cards" style="margin-top:18px">
          <div class="card"><h3>初回お支払い年月（2か月後）</h3><p id="first-date-campaign">-</p></div>
          <div class="card"><h3>最終お支払い年月</h3><p id="last-date-campaign">-</p></div>
          <div class="card"><h3>ボーナス情報</h3><p id="bonus-info-campaign">-</p></div>
          <div class="card"><h3>バリデーション</h3><p id="alerts-campaign">-</p></div>
        </div>
      </div>
      <div id="err" class="error" aria-live="polite"></div>
    </div>
  </section>

  <!-- 通常料金 -->
  <section id="tab-normal" class="tab-content">
    <div class="wrap">
      <h2>信販シミュレーター（通常）</h2>

      <div class="row" id="normal-picker">
        <label>カテゴリ<select id="normal-cat"></select></label>
        <label>部位（プラン名）<select id="normal-item"></select></label>
      </div>
      <div class="row">
        <label>回数<select id="normal-course">
          <option value="1">1回</option>
          <option value="4">4回</option>
          <option value="8">8回</option>
          <option value="12">12回</option>
        </select></label>
        <label>金額（税込）<input id="normal-price" readonly value="0"></label>
        <div class="btn-wrap"><button id="normal-apply" type="button">この金額で計算</button></div>
      </div>

      <div class="row">
        <div class="btn-wrap">
          <button id="normal-add" type="button">＋追加</button>
        </div>
      </div>
      <div class="row">
        <table>
          <thead><tr><th>カテゴリ</th><th>部位（プラン名）</th><th>回数</th><th>金額</th><th>操作</th></tr></thead>
          <tbody id="normal-combo-body"></tbody>
        </table>
      </div>
      <div class="row">
        <label>テーブル合計（税込）<input id="normal-combo-total" readonly value="0"></label>
        <div class="btn-wrap">
          <button id="normal-cart-apply" type="button">テーブル合計で計算</button>
        </div>
      </div>

      <div class="row">
        <label>プラン総額（税込）<input type="number" id="total-normal" value="0"></label>
        <label>頭金（1000円以上・千円単位）<input type="number" id="downPayment-normal" value="0" min="0" step="1000"></label>
      </div>
      <div class="row">
        <label>支払い回数（1,2,6〜50回）<select id="months-normal"></select></label>
        <label>ボーナス利用<select id="bonus-toggle-normal"><option value="off" selected>なし</option><option value="on">あり</option></select></label>
      </div>
      <div class="row" id="bonus-row-normal" style="display:none">
        <label>ボーナス加算金（千円単位/月）<input type="number" id="bonus-normal" value="0" min="0" step="1000"></label>
        <label>ボーナス支払月（夏）<select id="bonus-summer-normal"><option value="">選択なし</option><option value="6">6月</option><option value="7">7月</option><option value="8">8月</option></select></label>
        <label>ボーナス支払月（冬）<select id="bonus-winter-normal"><option value="">選択なし</option><option value="12">12月</option><option value="1">1月</option></select></label>
      </div>
      <div class="result">
        <div class="cards two-col">
          <div class="card"><h3>初回のお支払い</h3><p id="first-normal">¥0</p></div>
          <div class="card highlight"><h3>2回目以降のお支払い</h3><p id="monthly-normal">¥0</p></div>
          <div class="card"><h3>クレジット残高</h3><p id="principal-normal">¥0</p></div>
          <div class="card"><h3>分割手数料</h3><p id="fee-normal">¥0</p></div>
          <div class="card"><h3>分割支払い金合計</h3><p id="sum-normal">¥0</p></div>
          <div class="card"><h3>支払総額（頭金含む）</h3><p id="grand-normal">¥0</p></div>
        </div>
        <div class="cards" style="margin-top:18px">
          <div class="card"><h3>初回お支払い年月（2か月後）</h3><p id="first-date-normal">-</p></div>
          <div class="card"><h3>最終お支払い年月</h3><p id="last-date-normal">-</p></div>
          <div class="card"><h3>ボーナス情報</h3><p id="bonus-info-normal">-</p></div>
          <div class="card"><h3>バリデーション</h3><p id="alerts-normal">-</p></div>
        </div>
      </div>
    </div>
  </section>

  <!-- 共通：タブ切替・年号・エラー表示 -->
  <script>
  (function () {
    document.addEventListener("click", function (ev) {
      var tabEl = ev.target.closest && ev.target.closest(".tab");
      if (!tabEl) return;
      var name = tabEl.getAttribute("data-tab");
      document.querySelectorAll(".tab").forEach(function (node) { node.classList.remove("active"); });
      tabEl.classList.add("active");
      document.querySelectorAll(".tab-content").forEach(function (pane) { pane.classList.remove("active"); });
      var targetPane = document.getElementById("tab-" + name);
      if (targetPane) targetPane.classList.add("active");
    });

    window.addEventListener("error", function (ev) {
      var box = document.getElementById("err");
      var msg = '';
      try {
        if (ev && ev.error && (ev.error.message || ev.error.name)) {
          msg = (ev.error.name ? (ev.error.name + ": ") : "") + (ev.error.message || "");
        } else if (ev && ev.message) {
          msg = ev.message;
        } else {
          msg = String(ev);
        }
      } catch (_e) {
        msg = String(ev);
      }
      if (box) box.textContent = "エラー: " + msg;
      try { console.error(ev); } catch (_) {}
    });

    try {
      var y = new Date().getFullYear();
      var cp = document.getElementById("copyright");
      if (cp) cp.textContent = "©" + y + " 神 拓斗";
    } catch (_e) {}
  })();
  </script>

  <!-- キャンペーン：データ & 初期化 -->
  <script>
  (function(){
    function clone(o){return JSON.parse(JSON.stringify(o||{}))}
    var D={
      'ヒゲ':{
        '8回（保証20％）':110660,
        '12回（保証20％）':143770,
        '12回+1年（保証20％）':277750,
        'EP12回+1年（保証20％）':339800,
        'EP12回+1年プラチナ（保証50％）':389800
      },
      'フェイス':{
        '8回（保証20％）':158430,
        '12回（保証20％）':197000,
        '12回+1年（保証20％）':326890,
        'EP12回+1年（保証20％）':374260,
        'EP12回+1年プラチナ（保証50％）':424260
      },
      'どこでも脱毛':{
        '20分8回（保証20％）':129800,
        '20分12回（保証20％）':178000,
        '20分12回+1年（保証20％）':309000,
        '20分12回+1年プラチナ（保証50％）':359000,
        '40分4回（保証20％）':119800,
        '40分8回（保証20％）':228000,
        '40分12回（保証20％）':329000,
        '40分12回+1年（保証20％）':569000,
        '40分12回+1年プラチナ（保証50％）':619000
      },
      '陰部':{
        '4回（保証20％）':98300,
        '8回（保証20％）':194420,
        '12回（保証20％）':279970,
        '12回+1年（保証20％）':448860,
        '12回+1年プラチナ（保証50％）':498860
      },
      '全身':{
        '4回（保証20％）':196800,
        '8回（保証20％）':359750,
        '12回（保証20％）':506480,
        '12回+1年（保証20％）':795160,
        '12回+1年プラチナ（保証50％）':845160
      },
      '全身ヒゲ':{
        '4回（保証20％）':213400,
        '8回（保証20％）':396640,
        '12回（保証20％）':554420,
        '12回+1年（保証20％）':887750,
        '12回+1年プラチナ（保証50％）':937750,
        'EP12回+1年プラチナ（保証50％）':1054420
      },
      // ★差し替え済み：眉小鼻（キャンペーン）
      '眉小鼻':{
        '4回':40000,
        '8回':68250,
        '12回':81900
      },
      '大人の身だしなみケアプラン':{
        '口回りセット8回':60000,'ヒゲ全体セット8回':72000,'ひじ下、手の甲指セット8回':60000,
        '胸腹セット8回':78000,'上半身セット8回':132000,'下半身セット8回':120000,
        'VIOおしりセット8回':174000,'選べる2点セット8回':117000,'選べる3セット8回':171000
      }
    };

    function migrate(o){
      var x=clone(o||{});
      Object.keys(D).forEach(function(k){ x[k]=Object.assign({}, D[k], x[k]||{}) });
      // localStorage に古い眉小鼻定義が残っていても必ず差し替える
      x['眉小鼻']=Object.assign({}, D['眉小鼻']);
      Object.keys(x).forEach(function(cat){
        var src=x[cat]||{}; var dst={}; var seen=new Set();
        Object.keys(src).forEach(function(k){
          var nk=(k||'').replace(/保障/g,'保証').replace(/　/g,' ').replace(/\s+/g,' ').trim();
          if(!seen.has(nk)){
            dst[nk]=src[k];
            seen.add(nk);
          }
        });
        x[cat]=dst;
      });
      return x;
    }

    function get(){
      try{ var raw=localStorage.getItem('CAMPAIGN_DEF'); if(raw){ var o=JSON.parse(raw); if(o&&typeof o==='object') return migrate(o) } }
      catch(e){}
      return clone(D);
    }
    function set(o){ try{ localStorage.setItem('CAMPAIGN_DEF',JSON.stringify(o)) }catch(e){} }

    function ensureMonths(id){
      var el=document.getElementById(id); if(!el) return;
      if(el.options.length<=2){
        var base=[1,2]; for(var m=6;m<=50;m++) base.push(m);
        el.innerHTML='';
        var ph=document.createElement('option'); ph.value=''; ph.textContent='回数を選択'; el.appendChild(ph);
        base.forEach(function(v){var o=document.createElement('option');o.value=String(v);o.textContent=v+'回';el.appendChild(o)});
        el.value='';
      }
    }

    function reload(){
      var c=document.getElementById('cat-select-c');
      var p=document.getElementById('plan-select-c');
      var price=document.getElementById('selected-plan-price-c');
      var addBtn=document.getElementById('add-plan-c');
      if(!c||!p) return;

      var M=get(); var dict=M[c.value]||{};
      p.innerHTML='';

      var keys=Object.keys(dict);
      if(!keys.length){
        var op=document.createElement('option'); op.value=''; op.textContent='（このカテゴリにプランがありません）';
        p.appendChild(op);
        if(price) price.value='0';
        if(addBtn) addBtn.disabled=true;
        return;
      }
      if(addBtn) addBtn.disabled=false;

      var seen=new Set();
      keys.forEach(function(k){
        var label=(k||'').replace(/保障/g,'保証').replace(/　/g,' ').replace(/\s+/g,' ').trim();
        if(seen.has(label)) return;
        seen.add(label);
        var op=document.createElement('option'); op.value=label; op.textContent=label; p.appendChild(op);
      });

      if(price){
        var v=dict[p.value]||0;
        price.value=(Number(v)||0).toLocaleString();
      }
    }

    document.addEventListener('DOMContentLoaded',function(){
      ensureMonths('months-campaign'); ensureMonths('months-normal');
      reload();
      var c=document.getElementById('cat-select-c');
      var p=document.getElementById('plan-select-c');
      var price=document.getElementById('selected-plan-price-c');
      if(c) c.addEventListener('change',reload);
      if(p) p.addEventListener('change',function(){
        var dict=(get()[c.value]||{});
        if(price) price.value=(Number(dict[p.value]||0)).toLocaleString();
      });
    });

    window.__getCampaign=get; window.__setCampaign=set; window.__ensureMonths=ensureMonths; window.__reloadCampaignPlans=reload;
  })();
  </script>

  <!-- キャンペーン：計算とUI（プラン行DOM描画版） -->
  <script>
  (function(){
    'use strict';

    function toJPY(n){return '¥'+Math.max(0,Math.floor(n||0)).toLocaleString()}
    function el(id){return document.getElementById(id)}
    function num(id){var e=el(id);return e?Number(e.value||0):0}

    var tier={matsu:[],take:[],ume:[]}, current='matsu';
    var custom={matsu:null,take:null,ume:null};

    function sum(t){return (tier[t]||[]).reduce(function(a,b){return a+(+b.amount||0)},0)}
    function anyStudent(t){return (tier[t]||[]).some(function(x){return !!x.student})}

    // --- Swipe reorder: プラン①〜③カードを上下スワイプで並び替え ---
    function wireSwipeReorder(){
      var container = document.getElementById('compare-cards');
      if(!container) return;

      function list(){ return Array.prototype.slice.call(container.querySelectorAll('.plan-card')); }

      function swap(card, dir){
        var arr = list();
        var idx = arr.indexOf(card);
        if(idx < 0) return;
        var to = idx + (dir < 0 ? -1 : 1);
        if(to < 0 || to >= arr.length) return;
        var other = arr[to];
        if(dir < 0){
          container.insertBefore(card, other);
        }else{
          container.insertBefore(other, card);
        }
      }

      function bindPointer(card){
        if(card.__swipeBound) return;
        card.__swipeBound = true;

        var startX = 0, startY = 0;
        var swapped = false;

        function down(ev){
          if(ev.target && ev.target.closest && ev.target.closest('button,a,input,select,textarea')) return;
          card.classList.add('swiping');
          swapped = false;
          startX = ev.clientX;
          startY = ev.clientY;
          if(card.setPointerCapture) card.setPointerCapture(ev.pointerId);
        }

        function move(ev){
          if(!card.classList.contains('swiping')) return;
          if(swapped) return;
          var dx = ev.clientX - startX;
          var dy = ev.clientY - startY;
          if(Math.abs(dy) < 38) return;
          if(Math.abs(dy) < Math.abs(dx) + 12) return;

          swap(card, dy < 0 ? -1 : 1);
          swapped = true;
          card.__swipeJustSwapped = true;
          setTimeout(function(){ card.__swipeJustSwapped = false; }, 250);

          if(ev.preventDefault) ev.preventDefault();
        }

        function end(){ card.classList.remove('swiping'); }

        card.addEventListener('pointerdown', down);
        card.addEventListener('pointermove', move);
        card.addEventListener('pointerup', end);
        card.addEventListener('pointercancel', end);
        card.addEventListener('lostpointercapture', end);
      }

      function bindTouch(card){
        if(card.__swipeBound) return;
        card.__swipeBound = true;

        var startX = 0, startY = 0;
        var swapped = false;

        function tstart(ev){
          if(ev.target && ev.target.closest && ev.target.closest('button,a,input,select,textarea')) return;
          var t = (ev.touches && ev.touches[0]) ? ev.touches[0] : null;
          if(!t) return;
          card.classList.add('swiping');
          swapped = false;
          startX = t.clientX;
          startY = t.clientY;
        }

        function tmove(ev){
          if(!card.classList.contains('swiping')) return;
          if(swapped) return;
          var t = (ev.touches && ev.touches[0]) ? ev.touches[0] : null;
          if(!t) return;
          var dx = t.clientX - startX;
          var dy = t.clientY - startY;
          if(Math.abs(dy) < 38) return;
          if(Math.abs(dy) < Math.abs(dx) + 12) return;

          swap(card, dy < 0 ? -1 : 1);
          swapped = true;
          card.__swipeJustSwapped = true;
          setTimeout(function(){ card.__swipeJustSwapped = false; }, 250);

          ev.preventDefault();
        }

        function tend(){ card.classList.remove('swiping'); }

        card.addEventListener('touchstart', tstart, {passive:true});
        card.addEventListener('touchmove', tmove, {passive:false});
        card.addEventListener('touchend', tend);
        card.addEventListener('touchcancel', tend);
      }

      list().forEach(function(card){
        if(window.PointerEvent) bindPointer(card);
        else bindTouch(card);
      });
    }

    
    function renderPlanLinesInto(t, wrap){
      if(!wrap) return;
      wrap.innerHTML='';
      var items=tier[t]||[];
      if(!items.length){
        var empty=document.createElement('span'); empty.className='planline'; empty.textContent='（プラン未選択）';
        wrap.appendChild(empty); return;
      }
      items.forEach(function(x){
        var o=+x.orig||+x.amount||0; var a=+x.amount||0; var d=Math.max(0,o-a);
        var line=document.createElement('span'); line.className='planline';
        var name='['+x.cat+'] '+x.name+(x.student?'（学割）':'');
        line.textContent = d>0 ? (name+' '+toJPY(o)+' → -'+toJPY(d)+' = '+toJPY(a)) : (name+' '+toJPY(a));
        wrap.appendChild(line);
      });
    }

    function renderPlanLines(t){
      renderPlanLinesInto(t, el('planlist-'+t));
    }

    function renderPlanLinesMini(t){
      renderPlanLinesInto(t, el('mini-planlist-'+t));
    }


    function mark(){
      document.querySelectorAll('.pill').forEach(function(p){
        var on=p.getAttribute('data-target')===current;
        p.classList.toggle('active',on); p.setAttribute('aria-selected',on?'true':'false');
      });
      document.querySelectorAll('.plan-card').forEach(function(c){
        c.classList.toggle('active',c.getAttribute('data-tier')===current);
      });
    
      document.querySelectorAll('.mini-card').forEach(function(c){
        c.classList.toggle('active',c.getAttribute('data-tier')===current);
      });
}

    function compute(total,down,months,bonus,summer,winter){
      var rate=.008;
      var principal=Math.max(0,total-down);
      var fee=Math.floor(principal*rate*months);
      var sumAll=principal+fee;

      var now=new Date();
      var firstDate=new Date(now.getFullYear(),now.getMonth()+2,1);
      var lastDate=new Date(firstDate.getFullYear(),firstDate.getMonth()+(Math.max(1,months)-1),1);

      var sel=[]; if(['6','7','8'].indexOf(String(summer))>=0) sel.push(+summer); if(['12','1'].indexOf(String(winter))>=0) sel.push(+winter);
      var cnt=0;
      if(bonus>0 && sel.length){
        for(var i=0;i<months;i++){
          var dt=new Date(firstDate.getFullYear(), firstDate.getMonth()+i, 1);
          var mm=dt.getMonth()+1;
          if(sel.indexOf(mm)>=0){ cnt++; }
        }
      }
      var bonusTotal=bonus*cnt;

      var monthly=Math.floor(((sumAll-bonusTotal)/Math.max(1,months))/100)*100;
      var first=(sumAll-bonusTotal)-monthly*(Math.max(1,months)-1);

      return {principal:principal,fee:fee,sum:sumAll,first:first,monthly:monthly,grand:sumAll+down,firstDate:firstDate,lastDate:lastDate,bonusCount:cnt,bonusTotal:bonusTotal};
    }
    function ym(d){ if(!d) return '-'; var y=d.getFullYear(), m=('0'+(d.getMonth()+1)).slice(-2); return y+'年'+m+'月'; }

    function inputsComplete(){
      var togg=el('bonus-toggle-campaign'); var need=(togg&&togg.value==='on');
      var a=(el('downPayment-campaign')||{}).value==='';
      var b=(el('months-campaign')||{}).value==='';
      var c=need&&((el('bonus-campaign')||{}).value==='');
      return !(a||b||c);
    }
    function buildAlerts(total){
      if(!(total>0))return []; if(!inputsComplete()) return [];
      var down=num('downPayment-campaign'),months=Math.max(1,num('months-campaign')),bonus=Math.max(0,num('bonus-campaign'));
      var s=(el('bonus-summer-campaign')||{}).value||''; var w=(el('bonus-winter-campaign')||{}).value||'';
      var r=compute(total,down,months,bonus,s,w); var arr=[];
      if(bonus>0&&r.bonusCount>0){
        var principal=Math.max(0,total-down); var limit=Math.floor(principal*0.5);
        if(r.bonusTotal>limit){
          var per=r.bonusCount>0?Math.floor(limit/r.bonusCount):0;
          arr.push('ボーナス加算金合計はクレジット残金の50%以下にしてください。上限合計: '+toJPY(limit)+' ／ 1回あたり目安: '+toJPY(per));
        }
      }
      if(r.monthly<1700){arr.push('2回目以降分割払金が1700円以上になるように頭金、回数、ボーナスをご設定ください');}
      return arr;
    }

    function monthsOptions(){ var arr=[1,2]; for(var m=6;m<=50;m++) arr.push(m); return arr.map(function(v){ return '<option value="'+v+'">'+v+'回</option>'; }).join(''); }
    // 【スリム化】都度生成せず1回だけ作って使い回す（UIの挙動は同じ）
    var __monthsOptHtml = monthsOptions();

    function getParams(tierKey){
      var c=custom[tierKey];
      if(c&&c.enabled){
        return {down:Math.max(0, +c.down||0), months:Math.max(1, +c.months||1), bonus:Math.max(0, +c.bonus||0), summer:(c.summer||''), winter:(c.winter||''), source:'custom'};
      }
      return {
        down:Math.max(0,num('downPayment-campaign')),
        months:Math.max(1,num('months-campaign')),
        bonus:Math.max(0,num('bonus-campaign')),
        summer:(el('bonus-summer-campaign')||{}).value||'',
        winter:(el('bonus-winter-campaign')||{}).value||'',
        source:'global'
      };
    }

    function applyStudent(orig){ var off=Math.min(Math.floor(orig*0.25),100000); var v=orig-off; return v; }

    function render(){
      var tbody=el('combo-body-c'); var totalBox=el('combo-total-c');
      if(!tbody||!totalBox) return;
      tbody.innerHTML='';
      (tier[current]||[]).forEach(function(it,i){
        var tr=document.createElement('tr'); tr.setAttribute('data-idx',i);
        tr.innerHTML = '<td>'+it.cat+'</td>'+
          '<td>'+it.name+(it.student?'（学割）':'')+'</td>'+
          '<td data-amt="'+it.amount+'">'+toJPY(it.amount)+'</td>'+
          '<td>'+
            '<div class="ops">'+
              '<button type="button" class="btn-discount">値修正</button>'+
              '<button type="button" class="btn-student">学</button>'+
              '<button type="button" class="btn-calc">別計算</button>'+
              '<button type="button" class="btn-del">削除</button>'+
            '</div>'+
            '<div class="discount-editor" hidden>'+
              '<input type="number" class="disc-input" min="0" max="100" step="1" placeholder="割引率%">'+
              '<button type="button" class="apply-disc">適用</button>'+
              '<button type="button" class="cancel-disc">キャンセル</button>'+
            '</div>'+
            '<div class="calc-editor" hidden>'+
              '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;margin-top:8px">'+
                '<input type="number" class="calc-down" min="0" step="1000" placeholder="頭金(円)">'+
                '<select class="calc-months"><option value="">回数</option>'+__monthsOptHtml+'</select>'+
                '<select class="calc-bonus-toggle"><option value="off">ボーナス無し</option><option value="on">ボーナス有り</option></select>'+
                '<input type="number" class="calc-bonus" min="0" step="1000" placeholder="ボーナス(円)" disabled>'+
                '<select class="calc-summer"><option value="">夏ボーナス月</option><option value="6">6月</option><option value="7">7月</option><option value="8">8月</option></select>'+
                '<select class="calc-winter"><option value="">冬ボーナス月</option><option value="12">12月</option><option value="1">1月</option></select>'+
              '</div>'+
              '<div class="ops" style="margin-top:8px">'+
                '<button type="button" class="apply-calc">適用</button>'+
                '<button type="button" class="reset-calc">解除</button>'+
                '<button type="button" class="cancel-calc">閉じる</button>'+
              '</div>'+
            '</div>'+
          '</td>';
        tbody.appendChild(tr);
      });
      totalBox.value=sum(current).toLocaleString();
      renderPlanLines(current);
    }

    function refreshCards(){
      var filledGlobal=inputsComplete();
      ['matsu','take','ume'].forEach(function(t){
        var price=el('price-'+t),m=el('monthly-tier-'+t),ann=el('ann-'+t),bd=el('badge-'+t),bdc=el('custbadge-'+t);
        var total=sum(t);
        if(price) price.textContent=toJPY(total);
        renderPlanLines(t);
        if(!(total>0)){
          if(m) m.textContent='月々 —';
          if(ann) ann.hidden=true;
          if(bd) bd.hidden=true;
          if(bdc) bdc.hidden=true;
          return;
        }
        var p=getParams(t);
        var filled = p.source==='custom' ? true : filledGlobal;
        if(!filled){
          if(m) m.textContent='月々 —';
          if(ann) ann.hidden=true;
          if(bd) bd.hidden=!anyStudent(t);
          if(bdc) bdc.hidden=(p.source!=='custom');
          return;
        }
        var r=compute(total,p.down,p.months,p.bonus,p.summer,p.winter);
        if(m) m.textContent='月々 '+toJPY(r.monthly);
        var alerts=[];
        if(p.bonus>0&&r.bonusCount>0){
          var limit=Math.floor(Math.max(0,total-p.down)*0.5);
          if(r.bonusTotal>limit) alerts.push('B超過');
        }
        if(r.monthly<1700) alerts.push('M<1700');
        if(ann) ann.hidden=(alerts.length===0);
        if(bd) bd.hidden=!anyStudent(t);
        if(bdc) bdc.hidden = (p.source!=='custom');
      });
      refreshMiniCards();

    }

    
    function refreshMiniCards(){
      ['matsu','take','ume'].forEach(function(t){
        var p=el('mini-price-'+t), m=el('mini-monthly-tier-'+t), bd=el('mini-badge-'+t), bdc=el('mini-custbadge-'+t);
        if(p) p.textContent = toJPY(sum(t));

        // 月々は既存カードの表示を流用
        var srcMonthly = el('monthly-tier-'+t);
        if(m) m.textContent = srcMonthly ? srcMonthly.textContent : '月々 —';

        renderPlanLinesMini(t);

        if(bd) bd.hidden = !anyStudent(t);
        var pinfo = getParams(t);
        if(bdc) bdc.hidden = (pinfo.source!=='custom');
      });
    }

    function bindMiniCardClicks(){
      document.querySelectorAll('.mini-card').forEach(function(c){
        function act(){
          current=c.getAttribute('data-tier');
          render(); refreshAll();
        }
        c.addEventListener('click', act);
        c.addEventListener('keydown', function(e){
          if(e.key==='Enter' || e.key===' '){ e.preventDefault(); act(); }
        });
      });
    }
function markRequired(){
      var d=el('downPayment-campaign'),m=el('months-campaign'),b=el('bonus-campaign'),t=el('bonus-toggle-campaign');
      if(d) d.classList.toggle('need-attn',(d.value===''));
      if(m) m.classList.toggle('need-attn',(m.value===''));
      if(b){ var need=(t&&t.value==='on'); b.classList.toggle('need-attn',need&&(b.value==='')); }
    }

    function refreshAll(){
      var total=sum(current);
      var tEl=el('total-campaign'); if(tEl) tEl.value=total;

      if(!(total>0) || !inputsComplete()){
        ['first-campaign','monthly-campaign','principal-campaign','fee-campaign','sum-campaign','grand-campaign'].forEach(function(id){ var e=el(id); if(e) e.textContent='¥0'; });
        if(el('first-date-campaign')) el('first-date-campaign').textContent='-';
        if(el('last-date-campaign')) el('last-date-campaign').textContent='-';
        if(el('bonus-info-campaign')) el('bonus-info-campaign').textContent='-';
        if(el('alerts-campaign')) el('alerts-campaign').textContent='-';
        refreshCards(); mark(); markRequired();
        return;
      }

      var p=getParams(current);
      var r=compute(total,p.down,p.months,p.bonus,p.summer,p.winter);
      ['principal-campaign','fee-campaign','sum-campaign','first-campaign','monthly-campaign','grand-campaign'].forEach(function(id,i){
        var v=[r.principal,r.fee,r.sum,r.first,r.monthly,r.grand][i];
        var e=el(id); if(e) e.textContent=toJPY(v);
      });
      var fd=el('first-date-campaign'); if(fd) fd.textContent=ym(r.firstDate);
      var ld=el('last-date-campaign'); if(ld) ld.textContent=ym(r.lastDate);
      var bi=el('bonus-info-campaign'); if(bi) bi.textContent=(p.bonus>0?('ボーナス回数: '+r.bonusCount+'回 / 合計: '+toJPY(r.bonusTotal)):'なし');
      var alerts=buildAlerts(total);
      var al=el('alerts-campaign'); if(al) al.textContent=alerts.length?alerts.join('\n'):'OK';
      refreshCards(); mark(); markRequired();
    }

    var tbody=document.getElementById('combo-body-c');
    if(tbody){
      tbody.addEventListener('click',function(e){
        var t=e.target; var tr=t.closest('tr'); if(!tr) return;
        var i=+tr.getAttribute('data-idx'); var it=tier[current][i]; if(!it) return;

        if(t.classList.contains('btn-del')){ tier[current].splice(i,1); render(); refreshAll(); return; }

        if(t.classList.contains('btn-discount')){
          var ed=tr.querySelector('.discount-editor'),inp=tr.querySelector('.disc-input');
          if(ed){
            var o=+it.orig||+it.amount||0; var rate=0;
            if(o>0&&it.amount>=0&&it.amount<=o) rate=Math.floor((1-(it.amount/o))*100);
            if(inp) inp.value=String(rate);
            ed.hidden=!ed.hidden;
          }
          return;
        }

        if(t.classList.contains('apply-disc')){
          var inp=tr.querySelector('.disc-input');
          var v=Math.max(0,Math.min(100,Math.floor(+((inp&&inp.value)||0))));
          var o=+it.orig||+it.amount||0; var a=Math.floor(o*(100-v)/100);
          it.amount=a; it.disc=Math.max(0,o-a); it.student=false;
          render(); refreshAll(); return;
        }

        if(t.classList.contains('cancel-disc')){ var ed=tr.querySelector('.discount-editor'); if(ed) ed.hidden=true; return; }

        if(t.classList.contains('btn-student')){
          if(!it.student){ var o=+it.orig||+it.amount||0; it.amount=applyStudent(o); it.student=true; }
          else{ var o0=+it.orig||0; it.amount=o0; it.student=false; }
          render(); refreshAll(); return;
        }

        if(t.classList.contains('btn-calc')){
          var ed2=tr.querySelector('.calc-editor'); if(!ed2) return;
          ed2.hidden=!ed2.hidden;
          var p=getParams(current);
          ed2.querySelector('.calc-down').value = (p.source==='custom') ? ((custom[current]&&custom[current].down)||0) : (num('downPayment-campaign')||'');
          ed2.querySelector('.calc-months').value = String(p.months||'');
          var togg=ed2.querySelector('.calc-bonus-toggle'); togg.value = (p.bonus>0)?'on':'off';
          var b=ed2.querySelector('.calc-bonus'); b.disabled=(togg.value==='off'); b.value = (p.bonus||'');
          ed2.querySelector('.calc-summer').value = p.summer||'';
          ed2.querySelector('.calc-winter').value = p.winter||'';
          if(!ed2.__bonusWired){
            ed2.__bonusWired=true;
            togg.addEventListener('change',function(){ b.disabled=(togg.value==='off'); });
          }
          return;
        }

        if(t.classList.contains('apply-calc')){
          var box=tr.querySelector('.calc-editor'); if(!box) return;
          var down=+(box.querySelector('.calc-down').value||0);
          var months=+(box.querySelector('.calc-months').value||0);
          var togg=box.querySelector('.calc-bonus-toggle').value;
          var bonus=+(box.querySelector('.calc-bonus').value||0);
          var summer=box.querySelector('.calc-summer').value||'';
          var winter=box.querySelector('.calc-winter').value||'';
          if(!(months>0)){ alert('回数を選択してください'); return; }
          custom[current]={enabled:true,down:down,months:months,bonus:(togg==='on')?bonus:0,summer:summer,winter:winter};
          render(); refreshAll(); return;
        }

        if(t.classList.contains('reset-calc')){ custom[current]=null; render(); refreshAll(); return; }
        if(t.classList.contains('cancel-calc')){ var ce=tr.querySelector('.calc-editor'); if(ce) ce.hidden=true; return; }
      });
    }

    function __parseJPY(v){
      if(v==null) return 0;
      var s=String(v).replace(/[^\d]/g,'');
      return Number(s||0)||0;
    }
    function __getSelectedCampaignAmount(){
      var catEl=document.getElementById('cat-select-c');
      var planEl=document.getElementById('plan-select-c');
      var cat=catEl?catEl.value:'';
      var name=planEl?planEl.value:'';
      var amt=0;

      try{
        var CAM=(window.__getCampaign?window.__getCampaign():null);
        if(CAM && CAM[cat] && CAM[cat][name]!=null){
          amt=Number(CAM[cat][name])||0;
        }
      }catch(e){
        amt=0;
      }
      if(!(amt>0)){
        amt = __parseJPY((document.getElementById('selected-plan-price-c')||{}).value);
      }
      try{ window.__debugLastAddPlan = {cat:cat, name:name, amount:amt}; }catch(_e){}
      return {cat:cat, name:name, amt:amt};
    }

    function __bindAddPlanButton(){
      var addBtn=document.getElementById('add-plan-c');
      if(!addBtn || addBtn.__addBound) return;
      addBtn.__addBound = true;

      addBtn.addEventListener('click', function(){
        var info = __getSelectedCampaignAmount();
        if(!(info.amt>0)){
          var eb=document.getElementById('err');
          if(eb) eb.textContent='金額が取得できません（カテゴリ/プラン選択、または定義を確認）';
          try{ console.error('add-plan failed', info); }catch(_e){}
          return;
        }
        tier[current].push({cat:info.cat,name:info.name,amount:info.amt,orig:info.amt,disc:0,student:false});
        render(); refreshAll();
      });
    }

    __bindAddPlanButton();
    document.addEventListener('DOMContentLoaded', __bindAddPlanButton);

    ['downPayment-campaign','months-campaign','bonus-campaign','bonus-summer-campaign','bonus-winter-campaign','bonus-toggle-campaign'].forEach(function(id){
      var e=el(id); if(!e) return;
      e.addEventListener('input',refreshAll);
      e.addEventListener('change',function(){
        if(id==='bonus-toggle-campaign'){
          var row=el('bonus-row-campaign');
          if(row) row.style.display=(e.value==='on')?'grid':'none';
        }
        refreshAll();
      });
    });

    document.querySelectorAll('.pill').forEach(function(p){
      p.addEventListener('click',function(){
        current=p.getAttribute('data-target');
        render(); refreshAll();
      });
    });

    document.querySelectorAll('.plan-card').forEach(function(c){
      c.addEventListener('click',function(){
        if(c.__swipeJustSwapped) return;
        current=c.getAttribute('data-tier');
        render(); refreshAll();
      });
    });

    
    function __bindMiniCards(){
      document.querySelectorAll('.mini-card').forEach(function(c){
        if(c.__miniBound) return;
        c.__miniBound = true;

        function activate(){
          current = c.getAttribute('data-tier');
          render(); refreshAll();
        }

        c.addEventListener('click', function(){ activate(); });
        c.addEventListener('keydown', function(ev){
          if(ev.key === 'Enter' || ev.key === ' '){
            ev.preventDefault();
            activate();
          }
        });
      });
    }

    __bindMiniCards();
    document.addEventListener('DOMContentLoaded', __bindMiniCards);

document.addEventListener('DOMContentLoaded',function(){
      wireSwipeReorder();
      render(); refreshAll();
    });
  })();
  </script>

  <!-- 通常料金：データ & UI -->
  <script>
  (function(){
    'use strict';
    function toJPY(n){return '¥'+Math.max(0,Math.floor(n||0)).toLocaleString()}
    function el(id){return document.getElementById(id)}
    function num(id){var e=el(id);return e?Number(e.value||0):0}

    // 既存データを維持
    var NORMAL = {
      '顔・首全体': {
        '全部位': {1:86400, 4:308560, 8:618480, 12:928380},
        '口下': {1:10800, 4:38800, 8:77760, 12:116400},
        '両ほほ': {1:10800, 4:38800, 8:77760, 12:116400},
        '両もみあげ': {1:10800, 4:38800, 8:77760, 12:116400},
        '鼻下': {1:10800, 4:38800, 8:77760, 12:116400},
        'あご': {1:10800, 4:38800, 8:77760, 12:116400},
        'あご下・首': {1:11880, 4:42700, 8:85400, 12:128100},
        'まゆ上・眉間': {1:11880, 4:42700, 8:85400, 12:128100},
        '小鼻': {1:10800, 4:38800, 8:77760, 12:116400}
      },
      '上半身': {
        '全部位': {1:86500, 4:310400, 8:620800, 12:931200},
        '手の指': {1:3800, 4:13600, 8:27200, 12:40800},
        '手の甲': {1:5300, 4:19000, 8:38000, 12:57000},
        'ひじ下': {1:10800, 4:38800, 8:77600, 12:116400},
        'ひじ上': {1:10800, 4:38800, 8:77600, 12:116400},
        '胸全体': {1:10800, 4:38800, 8:77600, 12:116400},
        '腹全体': {1:10800, 4:38800, 8:77600, 12:116400},
        '乳輪周り': {1:5300, 4:19000, 8:38000, 12:57000},
        'へそ周り': {1:5300, 4:19000, 8:38000, 12:57000},
        '両わき': {1:5300, 4:19000, 8:38000, 12:57000},
        '肩': {1:5300, 4:19000, 8:38000, 12:57000},
        '背中上': {1:6500, 4:23400, 8:46800, 12:70200},
        '背中下': {1:6500, 4:23400, 8:46800, 12:70200}
      },
      '下半身': {
        '全部位': {1:87400, 4:314600, 8:629200, 12:943800},
        '足の指': {1:9200, 4:33100, 8:66200, 12:99300},
        '足の甲': {1:14200, 4:51100, 8:102200, 12:153300},
        'ひざ下': {1:32000, 4:115200, 8:230400, 12:345600},
        'ひざ上': {1:32000, 4:115200, 8:230400, 12:345600}
      },
      'デリケート': {
        '全部位': {1:88000, 4:316800, 8:633600, 12:950400},
        'Vライン': {1:22000, 4:79200, 8:158400, 12:237600},
        'Iライン': {1:22000, 4:79200, 8:158400, 12:237600},
        'Oライン': {1:22000, 4:79200, 8:158400, 12:237600},
        'おしり': {1:22000, 4:79200, 8:158400, 12:237600}
      }
    };

    function ensureMonths(id){
      var e=el(id); if(!e) return;
      e.innerHTML='';
      var base=[1,2]; for(var m=6;m<=50;m++) base.push(m);
      base.forEach(function(v){ var o=document.createElement('option'); o.value=String(v); o.textContent=v+'回'; e.appendChild(o); });
      e.value='12';
    }

    function loadCats(){
      var cat=el('normal-cat'); if(!cat) return;
      cat.innerHTML='';
      Object.keys(NORMAL).forEach(function(k){ var o=document.createElement('option'); o.value=k; o.textContent=k; cat.appendChild(o); });
    }

    function loadItems(){
      var cat=el('normal-cat'); var item=el('normal-item'); if(!cat||!item) return;
      item.innerHTML='';
      var dict=NORMAL[cat.value]||{};
      Object.keys(dict).forEach(function(k){ var o=document.createElement('option'); o.value=k; o.textContent=k; item.appendChild(o); });
      syncPrice();
    }

    function syncPrice(){
      var cat=el('normal-cat'); var item=el('normal-item'); var course=el('normal-course'); var price=el('normal-price');
      if(!cat||!item||!course||!price) return;
      var v=((NORMAL[cat.value]||{})[item.value]||{})[Number(course.value)]||0;
      price.value=String(v.toLocaleString());
    }

    // 計算はキャンペーンと同じロジック（ここは挙動維持のため重複のまま）
    function compute(total,down,months,bonus,summer,winter){
      var rate=.008;
      var principal=Math.max(0,total-down);
      var fee=Math.floor(principal*rate*months);
      var sumAll=principal+fee;
      var now=new Date();
      var firstDate=new Date(now.getFullYear(),now.getMonth()+2,1);
      var lastDate=new Date(firstDate.getFullYear(),firstDate.getMonth()+(Math.max(1,months)-1),1);

      var sel=[]; if(['6','7','8'].indexOf(String(summer))>=0) sel.push(+summer); if(['12','1'].indexOf(String(winter))>=0) sel.push(+winter);
      var cnt=0;
      if(bonus>0 && sel.length){
        for(var i=0;i<months;i++){
          var dt=new Date(firstDate.getFullYear(), firstDate.getMonth()+i, 1);
          var mm=dt.getMonth()+1;
          if(sel.indexOf(mm)>=0){ cnt++; }
        }
      }
      var bonusTotal=bonus*cnt;

      var monthly=Math.floor(((sumAll-bonusTotal)/Math.max(1,months))/100)*100;
      var first=(sumAll-bonusTotal)-monthly*(Math.max(1,months)-1);
      return {principal:principal,fee:fee,sum:sumAll,first:first,monthly:monthly,grand:sumAll+down,firstDate:firstDate,lastDate:lastDate,bonusCount:cnt,bonusTotal:bonusTotal};
    }
    function ym(d){ if(!d) return '-'; var y=d.getFullYear(), m=('0'+(d.getMonth()+1)).slice(-2); return y+'年'+m+'月'; }

    var normalCart=[];
    function cartSum(){ return normalCart.reduce(function(a,b){ return a+(+b.amount||0); },0); }

    function renderCart(){
      var body=el('normal-combo-body'); var total=el('normal-combo-total');
      if(!body||!total) return;
      body.innerHTML='';
      normalCart.forEach(function(it,idx){
        var tr=document.createElement('tr');
        tr.innerHTML='<td>'+it.cat+'</td><td>'+it.item+'</td><td>'+it.course+'回</td><td>'+toJPY(it.amount)+'</td>'+
          '<td><button type="button" data-del="'+idx+'">削除</button></td>';
        body.appendChild(tr);
      });
      total.value=String(cartSum().toLocaleString());
    }

    function applyTotalToCalc(total){
      el('total-normal').value=String(total);
      refreshNormal();
    }

    function refreshNormal(){
      var total=num('total-normal');
      var down=num('downPayment-normal');
      var months=num('months-normal');
      var bonusToggle=el('bonus-toggle-normal');
      var bonus=(bonusToggle&&bonusToggle.value==='on')?num('bonus-normal'):0;
      var summer=(el('bonus-summer-normal')||{}).value||'';
      var winter=(el('bonus-winter-normal')||{}).value||'';

      if(!(total>0) || !(months>0)){
        ['first-normal','monthly-normal','principal-normal','fee-normal','sum-normal','grand-normal'].forEach(function(id){ var e=el(id); if(e) e.textContent='¥0'; });
        if(el('first-date-normal')) el('first-date-normal').textContent='-';
        if(el('last-date-normal')) el('last-date-normal').textContent='-';
        if(el('bonus-info-normal')) el('bonus-info-normal').textContent='-';
        if(el('alerts-normal')) el('alerts-normal').textContent='-';
        return;
      }

      var r=compute(total,down,months,bonus,summer,winter);
      ['principal-normal','fee-normal','sum-normal','first-normal','monthly-normal','grand-normal'].forEach(function(id,i){
        var v=[r.principal,r.fee,r.sum,r.first,r.monthly,r.grand][i];
        var e=el(id); if(e) e.textContent=toJPY(v);
      });
      if(el('first-date-normal')) el('first-date-normal').textContent=ym(r.firstDate);
      if(el('last-date-normal')) el('last-date-normal').textContent=ym(r.lastDate);
      if(el('bonus-info-normal')) el('bonus-info-normal').textContent=(bonus>0?('ボーナス回数: '+r.bonusCount+'回 / 合計: '+toJPY(r.bonusTotal)):'なし');

      var alerts=[];
      if(r.monthly<1700) alerts.push('M<1700');
      if(bonus>0&&r.bonusCount>0){
        var limit=Math.floor(Math.max(0,total-down)*0.5);
        if(r.bonusTotal>limit) alerts.push('B超過');
      }
      if(el('alerts-normal')) el('alerts-normal').textContent=alerts.length?alerts.join('\n'):'OK';
    }

    document.addEventListener('DOMContentLoaded',function(){
      ensureMonths('months-normal');
      loadCats();
      loadItems();

      el('normal-cat').addEventListener('change',loadItems);
      el('normal-item').addEventListener('change',syncPrice);
      el('normal-course').addEventListener('change',syncPrice);

      el('normal-apply').addEventListener('click',function(){
        var v=Number(String(el('normal-price').value||'0').replace(/,/g,''))||0;
        applyTotalToCalc(v);
      });

      el('normal-add').addEventListener('click',function(){
        var cat=el('normal-cat').value;
        var item=el('normal-item').value;
        var course=Number(el('normal-course').value);
        var v=Number(String(el('normal-price').value||'0').replace(/,/g,''))||0;
        if(!(v>0)) return;
        normalCart.push({cat:cat,item:item,course:course,amount:v});
        renderCart();
      });

      el('normal-combo-body').addEventListener('click',function(e){
        var btn=e.target.closest && e.target.closest('button');
        if(!btn) return;
        var i=btn.getAttribute('data-del');
        if(i===null) return;
        normalCart.splice(Number(i),1);
        renderCart();
      });

      el('normal-cart-apply').addEventListener('click',function(){
        applyTotalToCalc(cartSum());
      });

      ['total-normal','downPayment-normal','months-normal','bonus-normal','bonus-summer-normal','bonus-winter-normal','bonus-toggle-normal'].forEach(function(id){
        var e=el(id); if(!e) return;
        e.addEventListener('input',refreshNormal);
        e.addEventListener('change',function(){
          if(id==='bonus-toggle-normal'){
            var row=el('bonus-row-normal');
            if(row) row.style.display=(e.value==='on')?'grid':'none';
            el('bonus-normal').disabled=(e.value!=='on');
          }
          refreshNormal();
        });
      });

      renderCart();
      refreshNormal();
    });
  })();
  </script>


  <!-- POP UI SCRIPT -->
  <script>
  (function(){
    'use strict';

    // POP -> キャンペーン選択を確実に同期する（料金表タブの追加ボタン用）
    function setCampaignSelection(cat, plan){
      var catSel = document.getElementById('cat-select-c');
      var planSel = document.getElementById('plan-select-c');
      if(!catSel || !planSel) return false;

      catSel.value = cat;

      // プラン一覧を更新（両方を実行：関数呼び出し + changeイベント）
      try{ if(window.__reloadCampaignPlans) window.__reloadCampaignPlans(); }catch(e){}
      fireChange(catSel);

      var want = normKey(plan);
      var opts = Array.prototype.slice.call(planSel.options || []);
      var found = opts.find(function(o){ return normKey(o.value) === want; }) ||
                  opts.find(function(o){ return normKey(o.textContent) === want; });

      if(!found) return false;

      planSel.value = found.value;
      fireChange(planSel);
      return true;
    }

    function addSelected(){
      var btn = document.getElementById('add-plan-c');
      if(!btn || btn.disabled) return false;
      btn.click();
      return true;
    }



    function normKey(s){
      return String(s||'').replace(/保障/g,'保証').replace(/　/g,' ').replace(/\s+/g,' ').trim();
    }
    function toJPY(n){
      return '¥' + Math.max(0, Math.floor(n||0)).toLocaleString();
    }
    function fireChange(el){
      if(!el) return;
      try{ el.dispatchEvent(new Event('change', {bubbles:true})); }
      catch(e){ try{ var ev=document.createEvent('Event'); ev.initEvent('change',true,true); el.dispatchEvent(ev);}catch(_){} }
    }

    // POPデータ（PDF内容を元にしたUI）
    var POPS = [
      { tag:'どこでも脱毛', title:'どこでも20分脱毛（新規）', cat:'どこでも脱毛', items:[
        {label:'8回', plan:'20分8回（保証20％）', total:129800},
        {label:'12回', plan:'20分12回（保証20％）', total:178000},
        {label:'12回+1年', plan:'20分12回+1年（保証20％）', total:309000},
        {label:'12回+1年+プラチナ', plan:'20分12回+1年プラチナ（保証50％）', total:359000}
      ]},
      { tag:'どこでも脱毛', title:'どこでも40分脱毛（新規）', cat:'どこでも脱毛', items:[
        {label:'4回', plan:'40分4回（保証20％）', total:119800},
        {label:'8回', plan:'40分8回（保証20％）', total:228000},
        {label:'12回', plan:'40分12回（保証20％）', total:329000},
        {label:'12回+1年', plan:'40分12回+1年（保証20％）', total:569000},
        {label:'12回+1年+プラチナ', plan:'40分12回+1年プラチナ（保証50％）', total:619000}
      ]},
      { tag:'全身', title:'全身+(ヒゲorVIO)脱毛（新規）', cat:'全身', items:[
        {label:'4回', plan:'4回（保証20％）', total:196800},
        {label:'8回', plan:'8回（保証20％）', total:359750},
        {label:'12回', plan:'12回（保証20％）', total:506480},
        {label:'12回+1年', plan:'12回+1年（保証20％）', total:795160},
        {label:'12回+1年+プラチナ', plan:'12回+1年プラチナ（保証50％）', total:845160}
      ]},
      { tag:'全身', title:'全身オール脱毛（新規）', cat:'全身ヒゲ', items:[
        {label:'4回', plan:'4回（保証20％）', total:213400},
        {label:'8回', plan:'8回（保証20％）', total:396640},
        {label:'12回', plan:'12回（保証20％）', total:554420},
        {label:'12回+1年', plan:'12回+1年（保証20％）', total:887750},
        {label:'12回+1年+プラチナ', plan:'12回+1年プラチナ（保証50％）', total:937750},
        {label:'EP12回+1年プラチナ', plan:'EP12回+1年プラチナ（保証50％）', total:1054420}
      ]},
      { tag:'VIO', title:'VIO脱毛（新規）', cat:'陰部', items:[
        {label:'4回', plan:'4回（保証20％）', total:98300},
        {label:'8回', plan:'8回（保証20％）', total:194420},
        {label:'12回', plan:'12回（保証20％）', total:279970},
        {label:'12回+1年', plan:'12回+1年（保証20％）', total:448860},
        {label:'12回+1年+プラチナ', plan:'12回+1年プラチナ（保証50％）', total:498860}
      ]},
      { tag:'フェイス', title:'フェイス脱毛（新規）', cat:'フェイス', items:[
        {label:'8回', plan:'8回（保証20％）', total:158430},
        {label:'12回', plan:'12回（保証20％）', total:197000},
        {label:'12回+1年', plan:'12回+1年（保証20％）', total:326890},
        {label:'12回+1年+EP', plan:'EP12回+1年（保証20％）', total:374260},
        {label:'12回+1年+EP+プラチナ', plan:'EP12回+1年プラチナ（保証50％）', total:424260}
      ]},
      { tag:'ヒゲ', title:'ヒゲ脱毛（新規）', cat:'ヒゲ', items:[
        {label:'8回', plan:'8回（保証20％）', total:110660},
        {label:'12回', plan:'12回（保証20％）', total:143770},
        {label:'12回+1年', plan:'12回+1年（保証20％）', total:277750},
        {label:'12回+1年+EP', plan:'EP12回+1年（保証20％）', total:339800},
        {label:'12回+1年+EP+プラチナ', plan:'EP12回+1年プラチナ（保証50％）', total:389800}
      ]},
      { tag:'眉小鼻', title:'まゆ・小鼻脱毛', cat:'眉小鼻', items:[
        {label:'4回', plan:'4回', total:40000},
        {label:'8回', plan:'8回', total:68250},
        {label:'12回', plan:'12回', total:81900}
      ]}
    ];

    function selectAndAdd(cat, plan){
      var catSel = document.getElementById('cat-select-c');
      var planSel = document.getElementById('plan-select-c');
      var addBtn  = document.getElementById('add-plan-c');
      if(!catSel || !planSel || !addBtn) return false;

      if(catSel.value !== cat){
        catSel.value = cat;
        fireChange(catSel);
      }

      requestAnimationFrame(function(){
        var want = normKey(plan);
        var opts = Array.prototype.slice.call(planSel.options || []);
        var found = opts.find(function(o){ return normKey(o.value) === want; });
        if(!found){
          var err = document.getElementById('err');
          if(err) err.textContent = 'POP連携: プランが見つかりません → ['+cat+'] '+plan;
          return;
        }
        planSel.value = found.value;
        fireChange(planSel);
        requestAnimationFrame(function(){ addBtn.click(); });
      });

      return true;
    }

    var syncing = false;
    function syncCategoryFromCampaign(){
      if(syncing) return;
      var camp = document.getElementById('cat-select-c');
      var pop  = document.getElementById('pop-cat-select');
      if(!camp || !pop) return;
      syncing = true;
      pop.value = camp.value;
      syncing = false;
      render();
    }
    function syncCategoryToCampaign(){
      if(syncing) return;
      var camp = document.getElementById('cat-select-c');
      var pop  = document.getElementById('pop-cat-select');
      if(!camp || !pop) return;
      syncing = true;
      camp.value = pop.value;
      fireChange(camp);
      syncing = false;
      render();
    }

    
    // --- 動的POP：キャンペーン定義を参照してPOPを生成（例：大人の身だしなみケアプラン） ---
    function buildPopFromCampaignCategory(cat){
      try{
        var camp = (window.__getCampaign ? window.__getCampaign() : null);
        if(!camp || !camp[cat] || typeof camp[cat] !== 'object') return [];
        var dict = camp[cat];
        var keys = Object.keys(dict).filter(function(k){ return dict[k]!=null; });
        if(keys.length === 0) return [];

        var items = keys.map(function(name){
          return {
            label: name,          // POPの「回数/コース名」として表示
            plan: name,           // 追加時に選択するプラン名（キャンペーンのプラン名と一致）
            total: Number(dict[name]) || 0
          };
        });

        // 並び替え：○回があれば回数順、それ以外は金額順
        function getTimes(s){
          var m = String(s||'').match(/(\d+)\s*回/);
          return m ? Number(m[1]) : null;
        }
        items.sort(function(a,b){
          var ta=getTimes(a.label), tb=getTimes(b.label);
          if(ta!=null && tb!=null) return ta-tb;
          if(ta!=null) return -1;
          if(tb!=null) return  1;
          if((a.total||0)!==(b.total||0)) return (a.total||0)-(b.total||0);
          return String(a.label).localeCompare(String(b.label));
        });

        return [{
          tag: '料金表',
          title: cat + '（キャンペーン参照）',
          cat: cat,
          items: items
        }];
      }catch(e){
        return [];
      }
    }

    function render(){
      var grid = document.getElementById('pop-grid');
      if(!grid) return;

      var popSel = document.getElementById('pop-cat-select');
      var cat = popSel ? popSel.value : '';
      var empty = document.getElementById('pop-empty');

      var all = POPS.concat(buildPopFromCampaignCategory('大人の身だしなみケアプラン'));
      var filtered = all.filter(function(p){ return !cat || p.cat === cat; });

      grid.innerHTML = '';

      if(!filtered.length){
        if(empty) empty.style.display = 'block';
        return;
      }
      if(empty) empty.style.display = 'none';

      // --- Hero (スクリーンショット寄せ) ---
      var hero = document.createElement('div');
      hero.className = 'pop-hero';

      var titleText = (filtered.length === 1 && filtered[0] && filtered[0].title) ? filtered[0].title : (cat || '料金表');
      hero.innerHTML =
        '<div class="pop-hero-inner">' +
          '<div class="pop-hero-top">' +
            '' +
            '<div class="pop-hero-title">' + titleText + '</div>' +
          '</div>' +
          '<div class="pop-hero-sub">回数を押すとプラン①〜③へ追加</div>' +
        '</div>' +
        '<div class="pop-hero-rule"></div>';

      grid.appendChild(hero);

      function esc(s){
        return String(s==null?'':s)
          .replace(/&/g,'&amp;')
          .replace(/</g,'&lt;')
          .replace(/>/g,'&gt;')
          .replace(/"/g,'&quot;')
          .replace(/'/g,'&#39;');
      }

      // --- Items ---
      filtered.forEach(function(pop){
        if(filtered.length > 1){
          var sh = document.createElement('div');
          sh.className = 'pop-subhead';
          sh.textContent = pop.title || '';
          grid.appendChild(sh);
        }

        (pop.items || []).forEach(function(it){
          var pill = document.createElement('div');
          pill.className = 'pop-pill';

          pill.innerHTML =
            '<div class="pop-pill-left">' +
              '<div class="k">' + esc(it.label) + '</div>' +
              '<div class="v">総額 ' + esc(toJPY(it.total)) + '</div>' +
            '</div>' +
            '<button class="pop-add" type="button">追加</button>';

          pill.querySelector('button').addEventListener('click', function(){
            // まずは“直接追加API”があればそれを使う（カテゴリ/プラン選択に依存しない）
            var direct = null;
            try{
              if(window.__addCampaignPlanDirect){
                direct = window.__addCampaignPlanDirect({cat: pop.cat, name: it.plan, amount: it.total});
              }
            }catch(e){ direct = {ok:false, reason:String(e && (e.message||e))}; }

            if(direct && direct.ok){
              var st = document.getElementById('pop-status');
              if(st){
                st.style.display='block';
                st.textContent = '追加しました：' + it.label + ' / ' + toJPY(it.total) + ' → プラン' + (direct.tier==='matsu'?'①':direct.tier==='take'?'②':'③');
              }
              return;
            }

            // 直接追加が使えない場合は従来方式（キャンペーンのセレクト→追加ボタン）
            var ok = setCampaignSelection(pop.cat, it.plan);
            if(!ok){
              var err = document.getElementById('err');
              if(err) err.textContent = 'POP連携: プランが見つかりません → ['+pop.cat+'] '+it.plan;
              var st=document.getElementById('pop-status');
              if(st){ st.style.display='block'; st.textContent='追加できません：プランが見つかりません（' + pop.cat + ' / ' + it.plan + '）'; }
              return;
            }
            requestAnimationFrame(function(){
              var ok2 = addSelected();
              var st = document.getElementById('pop-status');
              if(st){
                st.style.display='block';
                st.textContent = ok2 ? ('追加しました：' + it.label + ' / ' + toJPY(it.total)) : '追加に失敗しました（キャンペーン側の追加ボタンが無効です）';
              }
            });
          });

          grid.appendChild(pill);
        });
      });
    }


    document.addEventListener('DOMContentLoaded', function(){
      syncCategoryFromCampaign();

      var camp = document.getElementById('cat-select-c');
      var pop  = document.getElementById('pop-cat-select');
      if(camp) camp.addEventListener('change', syncCategoryFromCampaign);
      if(pop)  pop.addEventListener('change', syncCategoryToCampaign);

      render();
    });
  })();
  </script>

</body>
</html>